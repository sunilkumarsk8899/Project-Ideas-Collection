<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #screenshot-preview {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 160px;
            height: 90px;
            border: 2px solid #06b6d4; /* cyan-500 */
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            object-fit: cover;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            z-index: 50;
        }
        #screenshot-preview.visible {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-4xl mx-auto p-4 md:p-8">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-8">

            <!-- Header -->
            <div class="text-center">
                <h1 class="text-4xl font-bold text-cyan-400">Work Tracker</h1>
                <p class="text-gray-400 mt-2">Track your productivity with random screenshots and activity monitoring.</p>
            </div>

            <!-- Tracker Controls & Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 bg-gray-900/50 p-6 rounded-xl">
                <div class="flex flex-col items-center justify-center p-4 bg-gray-800 rounded-lg">
                    <span class="text-gray-400 text-sm font-medium">TIME ELAPSED</span>
                    <p id="timer" class="text-4xl font-mono font-semibold text-white">00:00:00</p>
                </div>
                <div class="flex flex-col items-center justify-center p-4 bg-gray-800 rounded-lg">
                    <span class="text-gray-400 text-sm font-medium">KEY STROKES</span>
                    <p id="key-count" class="text-4xl font-mono font-semibold text-white">0</p>
                </div>
                 <div class="flex flex-col items-center justify-center p-4 bg-gray-800 rounded-lg">
                    <span class="text-gray-400 text-sm font-medium">LAST KEY</span>
                    <p id="last-key" class="text-4xl font-mono font-semibold text-white">-</p>
                </div>
                <div class="flex flex-col items-center justify-center p-4 bg-gray-800 rounded-lg">
                    <span class="text-gray-400 text-sm font-medium">SCREENSHOTS</span>
                    <p id="screenshot-count" class="text-4xl font-mono font-semibold text-white">0</p>
                </div>
            </div>

            <!-- Buttons and Status -->
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <button id="start-btn" class="w-full sm:w-auto bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-lg shadow-cyan-500/20">
                    Start Tracking
                </button>
                <button id="stop-btn" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-lg shadow-red-500/20 hidden">
                    Stop Tracking
                </button>
            </div>
            <p id="status" class="text-center text-gray-500 min-h-[20px]"></p>

            <!-- Disclaimer -->
            <div id="disclaimer" class="bg-yellow-900/30 border border-yellow-700 text-yellow-300 px-4 py-3 rounded-lg text-sm">
                <p><strong class="font-bold">Important:</strong> This is a browser-based tool. You will be asked for screen-sharing and notification permission. Screenshots are stored only in your browser and will be lost if you close this page.</p>
            </div>

            <!-- Screenshot Gallery -->
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-center">Captured Screenshots</h2>
                <div id="screenshot-gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[150px] bg-gray-900/50 p-4 rounded-xl">
                   <div id="gallery-placeholder" class="col-span-full flex items-center justify-center text-gray-500">
                       Screenshots will appear here...
                   </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden video and canvas for processing screenshots -->
    <video id="video" playsinline autoplay muted class="hidden"></video>
    <canvas id="canvas" class="hidden"></canvas>
    
    <!-- Screenshot Preview Popup -->
    <img id="screenshot-preview" src="" alt="Screenshot preview">

    <script>
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const timerEl = document.getElementById('timer');
        const keyCountEl = document.getElementById('key-count');
        const lastKeyEl = document.getElementById('last-key');
        const screenshotCountEl = document.getElementById('screenshot-count');
        const statusEl = document.getElementById('status');
        const galleryEl = document.getElementById('screenshot-gallery');
        const galleryPlaceholder = document.getElementById('gallery-placeholder');
        const videoEl = document.getElementById('video');
        const canvasEl = document.getElementById('canvas');
        const disclaimerEl = document.getElementById('disclaimer');
        const screenshotPreviewEl = document.getElementById('screenshot-preview');

        let isTracking = false;
        let stream = null;
        let timerInterval = null;
        let screenshotTimeout = null;
        let previewTimeout = null;
        let startTime = 0;
        let keyStrokes = 0;
        let screenshots = [];
        const originalTitle = document.title;
        
        let audioCtx;
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch(e) {
            console.warn("Web Audio API is not supported in this browser.");
        }

        // --- Core Functions ---

        async function startTracking() {
            try {
                // Request notification permission
                if ('Notification' in window) {
                    await Notification.requestPermission();
                }

                statusEl.textContent = 'Requesting screen permission...';
                stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: 'screen' }
                });

                videoEl.srcObject = stream;
                videoEl.onloadedmetadata = () => {
                    videoEl.play();
                    isTracking = true;
                    startTime = Date.now();
                    keyStrokes = 0;
                    screenshots = [];
                    updateUIForTracking();
                    startTimer();
                    startKeyboardListener();
                    scheduleNextScreenshot();
                };

                stream.getVideoTracks()[0].onended = () => {
                    if (isTracking) stopTracking();
                };

            } catch (err) {
                console.error("Error starting screen capture:", err);
                if (err.name === 'NotAllowedError') {
                    statusEl.textContent = err.message.includes('permissions policy') 
                        ? 'Error: Screen capture is disallowed by security policies.' 
                        : 'Screen permission was denied. Please allow to start tracking.';
                } else {
                    statusEl.textContent = 'An unexpected error occurred.';
                }
                stopTracking();
            }
        }

        function stopTracking() {
            isTracking = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            clearInterval(timerInterval);
            clearTimeout(screenshotTimeout);
            clearTimeout(previewTimeout);
            stopKeyboardListener();
            statusEl.textContent = 'Tracking stopped.';
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            screenshotPreviewEl.classList.remove('visible');
        }

        function playScreenshotSound() {
            if (!audioCtx) return;
            // This creates a sound resembling a camera shutter
            const bufferSize = audioCtx.sampleRate * 0.1; // 0.1 second sound
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);

            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            source.start(0);
        }

        function showScreenshotPreview(url) {
            screenshotPreviewEl.src = url;
            screenshotPreviewEl.classList.add('visible');

            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                screenshotPreviewEl.classList.remove('visible');
            }, 4000);
        }

        function showCrossTabNotification(imageUrl) {
            // Blink tab title
            document.title = 'ðŸ“¸ Screenshot Captured!';
            setTimeout(() => { document.title = originalTitle; }, 3000);

            // Show system notification if permission is granted
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Work Tracker', {
                    body: 'A screenshot was just captured.',
                    icon: imageUrl,
                    silent: true,
                });
            }
        }

        function takeScreenshot() {
            if (!isTracking || !videoEl.srcObject) return;

            const context = canvasEl.getContext('2d');
            canvasEl.width = videoEl.videoWidth;
            canvasEl.height = videoEl.videoHeight;
            context.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);

            const dataUrl = canvasEl.toDataURL('image/jpeg', 0.8);
            const timestamp = new Date();
            screenshots.push({ url: dataUrl, time: timestamp });

            playScreenshotSound();
            showScreenshotPreview(dataUrl);
            showCrossTabNotification(dataUrl);
            updateGallery();
            scheduleNextScreenshot();
        }

        function scheduleNextScreenshot() {
            if (!isTracking) return;
            
            const intervalInSeconds = 10;
            const intervalInMs = intervalInSeconds * 1000;
            
            statusEl.textContent = `Tracking... Next screenshot in ${intervalInSeconds} seconds.`;
            
            clearTimeout(screenshotTimeout);
            screenshotTimeout = setTimeout(takeScreenshot, intervalInMs);
        }

        // --- Event Listeners & Timers ---

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                const seconds = Math.floor((elapsedTime / 1000) % 60);
                const minutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
                const hours = Math.floor((elapsedTime / (1000 * 60 * 60)) % 24);

                timerEl.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        const handleKeyPress = (e) => {
            keyStrokes++;
            keyCountEl.textContent = keyStrokes;
            let key = e.key;
            if (key === ' ') key = 'Space';
            if (key.length > 1) {
                key = key.replace('Arrow', '');
            }
            lastKeyEl.textContent = key;
        };

        function startKeyboardListener() {
            document.addEventListener('keydown', handleKeyPress);
        }

        function stopKeyboardListener() {
            document.removeEventListener('keydown', handleKeyPress);
        }

        // --- UI Update Functions ---
        
        function updateUIForTracking() {
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            disclaimerEl.classList.add('hidden');
            
            timerEl.textContent = '00:00:00';
            keyCountEl.textContent = '0';
            lastKeyEl.textContent = '-';
            screenshotCountEl.textContent = '0';
            galleryEl.innerHTML = '';
            galleryEl.appendChild(galleryPlaceholder);
            galleryPlaceholder.classList.remove('hidden');
        }

        function updateGallery() {
            screenshotCountEl.textContent = screenshots.length;
            if (screenshots.length > 0) galleryPlaceholder.classList.add('hidden');

            const lastScreenshot = screenshots[screenshots.length - 1];
            const card = document.createElement('a');
            card.href = lastScreenshot.url;
            card.target = '_blank';
            card.classList.add('relative', 'group', 'rounded-lg', 'overflow-hidden', 'shadow-lg');
            card.setAttribute('title', `View screenshot from ${lastScreenshot.time.toLocaleTimeString()}`);
            
            const img = document.createElement('img');
            img.src = lastScreenshot.url;
            img.classList.add('w-full', 'h-full', 'object-cover', 'transition-transform', 'duration-300', 'group-hover:scale-110');

            const overlay = document.createElement('div');
            overlay.classList.add('absolute', 'inset-0', 'bg-black/50', 'flex', 'items-center', 'justify-center', 'opacity-0', 'group-hover:opacity-100', 'transition-opacity', 'duration-300');
            
            const timeText = document.createElement('p');
            timeText.classList.add('text-white', 'font-bold', 'text-sm');
            timeText.textContent = lastScreenshot.time.toLocaleTimeString();

            overlay.appendChild(timeText);
            card.appendChild(img);
            card.appendChild(overlay);

            galleryEl.prepend(card);
        }

        // --- Initial Setup ---

        startBtn.addEventListener('click', startTracking);
        stopBtn.addEventListener('click', stopTracking);
    </script>
</body>
</html>

